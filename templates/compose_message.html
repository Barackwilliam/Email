{% extends 'base.html' %}
{% block title %}Compose Message{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Compose and Send Message</h2>

    <form method="POST" id="messageForm" action="{% url 'send_custom_message' %}">
        {% csrf_token %}
        
        <div class="mb-3">
            <label for="message_body" class="form-label">Your Message</label>
            <textarea class="form-control" id="message_body" name="message_body" rows="6" required></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Send To:</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="send_option" id="send_selected" value="selected" checked>
                <label class="form-check-label" for="send_selected">
                    Selected Emails Only
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="send_option" id="send_all" value="all">
                <label class="form-check-label" for="send_all">
                    All Emails
                </label>
            </div>
        </div>

        <!-- Hidden field to send selected IDs -->
        <input type="hidden" name="selected_ids" id="selected_ids" value="">

        <div class="table-responsive mb-4">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>School</th>
                        <th>Email</th>
                        <th>Phone</th>
                    </tr>
                </thead>
                <tbody>
                    {% for email in user_emails %}
                    <tr>
                        <td><input type="checkbox" class="email-checkbox" value="{{ email.id }}"></td>
                        <td>{{ email.school_name }}</td>
                        <td>{{ email.email }}</td>
                        <td>{{ email.phone_number }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <button type="submit" class="btn btn-primary w-100">Send Message</button>
    </form>
</div>

<script>
    document.getElementById("messageForm").addEventListener("submit", function (e) {
        const sendOption = document.querySelector('input[name="send_option"]:checked').value;
        if (sendOption === 'selected') {
            const selected = [...document.querySelectorAll('.email-checkbox:checked')].map(cb => cb.value);
            document.getElementById('selected_ids').value = selected.join(',');
        }
    });
</script>
{% endblock %}
